{% extends 'layout.html' %}
{% load static %}
{% block stylesheets %}
{% endblock stylesheets %}
{% block content_header %}
<div class="content-header row">
  <div class="content-header-left col-md-6 col-12 mb-2">
    <h3 class="content-header-title mb-0">Ingresos</h3>
    <div class="row breadcrumbs-top">
      <div class="breadcrumb-wrapper col-12">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/">Home</a>
          </li>
          <li class="breadcrumb-item">
            <a href="#">Ingresos</a>
          </li>
        </ol>
      </div>
    </div>
  </div>
  <div class="content-header-right col-md-6 col-12">
    <div class="float-md-right">
      <!-- <div class="dropdown dropleft">
        <button type="button" class="btn btn-info btn-lg btn-block dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Nuevo Caso
        </button>
        <div class="dropdown-menu dropdown-menu-left" aria-labelledby="dropdownMenuButton">
          <a href="/ingresos/new" class="dropdown-item">
            Ingreso completo
          </a>
          <a href="/ingresos/new" class="dropdown-item">
            Ingreso solo análisis
          </a>
          <a href="/ingresos/new" class="dropdown-item">
            Ingreso corte incluído
          </a>
        </div>
      </div> -->
      {% if edit %}
      <a href="/ingresos/new" class="btn btn-success btn-lg round">
        <i class="fa fa-plus"></i>
        Nuevo Caso
      </a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock content_header %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">Listado de Ingresos</h4>
      </div>
      <div class="card-content">
        <div class="card-body card-dashboard">
          <table class="table table-striped table-bordered zero-configuration">
            <thead>
              <tr>
                <!-- <th>Id</th> -->
                <th>Nro Caso</th>
                <th>Subflujo</th>
                <th>Cliente</th>
                <th>Fecha Inicio</th>
                <th>Etapa en curso</th>
                <th>Opciones</th>
              </tr>
            </thead>
            <tbody>
              {% for entryForm in entryForm_list %}
                  <tr id="form-{{ entryForm.id }}">
                    <!-- <td>{{ entryForm.content_object.id }}</td> -->
                    <td><strong>{{ entryForm.content_object.no_caso }}</strong></td>
                    <td>
                      {% if entryForm.content_object.get_subflow != "N/A" %}
                        Parte {{ entryForm.content_object.get_subflow }}
                      {% else %}
                        {{ entryForm.content_object.get_subflow }}
                      {% endif %}
                    </td>
                    <td>{{ entryForm.content_object.customer|default:"" }}</td>
                    <td>{{ entryForm.content_object.created_at|date:"d/m/Y" }}</td>
                    <td><a href="workflow/{{ entryForm.id }}/{{ entryForm.state.step.tag }}">{{ entryForm.state.step }}</a></td>
                    <td>
                      <div class="btn-group" role="group" aria-label="Opciones">
                        <button class="btn btn-sm btn-primary showSummaryBtn" data-id="{{ entryForm.content_object.pk }}"><i class="fa fa-list fa-fx"></i> Resumen</button>
                        {% if eliminar %}
                        <button type="button" data-id="{{ entryForm.id }}" class="btn btn-danger btn-sm deleteFlow"><i class="fa fa-trash fa-fx"></i> Eliminar</button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade text-left" id="show_summary" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog" role="document" style="min-width:80% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="title">Resumen Caso <span class="NoCasoSummary"></span></h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="font-size:12px !important; max-height: calc(100vh - 150px); overflow-y:scroll;">
        <div style="padding: 10px;background-color: #f2efed;">
          {% if edit %}
          <div class="col-md-12">
            <a href="javascript:void(0);" onclick="submitGeneralData()" class="btn btn-primary pull-right"> <i class="fa fa-save fa-2x"></i> </a>
          </div>
          {% endif %}
          <form action="#" id="generalData">
            <h6 class="form-section mt-2">  Información general</h6>
            <div class="row generalInfo">
              <div class="col-sm-4 form-group summaryClient">
              </div>
              <div class="col-sm-4 form-group summaryCompany">
              </div>
              <div class="col-sm-4 form-group summaryCenter">
              </div>
              <div class="col-sm-4 form-group summaryResponsible">
              </div>
              <div class="col-sm-4 form-group summaryReception">
              </div>
              <div class="col-sm-4 form-group sumarrySampling">
              </div>
              <div class="col-sm-4 form-group summaryNoOrder">
              </div>
              <div class="col-sm-4 form-group summaryNoRequest">
              </div>
              <div class="col-sm-4 form-group summaryFixative">
              </div>
            </div>
            <hr>
            <h6 class="form-section mt-2"> Detalle</h6>
            <div class="row ">
              <div class="col-sm-4 summarySpecie">
              </div>
              <div class="col-sm-4 summaryDevStatus">
              </div>
              <div class="col-sm-4 summaryWaterSource">
              </div>
            </div>
          </form>   
        </div>
        <div class="row">
          <div class="row col-sm-12 summaryIdentification" style="margin:0">
          </div>
          <div class="col-sm-4 summaryExams">
          </div>
          <div class="col-sm-8 summarySamples">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %} {% block scripts %}
<script type="text/javascript">

  $(document).on('click', '.deleteFlow', function(e){
    swal({
      title: "Confirmación",
      text: "¿Está seguro que desea eliminar este caso definitivamente?",
      icon: "warning",
      showCancelButton: true,
      buttons: {
        cancel: {
            text: "No, cancelar!",
            value: null,
            visible: true,
            className: "btn-warning",
            closeModal: true,
        },
        confirm: {
            text: "Sí, eliminar!",
            value: true,
            visible: true,
            className: "",
            closeModal: true,
        }
      }
    }).then(isConfirm => {
      if (isConfirm) {
        var form_id = $(this).data('id');
        var url = Urls.workflow_w_id(form_id);
        lockScreen(1);
        $.ajax({
          type: "DELETE",
          url: url,
          async: false,
        })
        .done(function (data) {
          response = data;
          if (response.ok) {
            toastr.success('', 'Se ha eliminado el caso exitosamente.');
            var timer = setTimeout(function() {
              window.location='/ingresos'
            }, 2000);
          } else {
            toastr.error('', 'No ha sido posible eliminar el caso.');
          }
        })
        .fail(function (data) {
          toastr.error('', 'No ha sido posible eliminar el caso.');
        });
      }
    });
  });

  $(document).ready(function () {
    var tableChildRows = $('.zero-configuration').DataTable({
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.10.16/i18n/Spanish.json"
      },
      ordering: false,
    });
  });
  var resumenId;
  $(document).on('click', '.showSummaryBtn', function(e){
    var entryform_id = $(this).data('id');
    resumenId = entryform_id;
    fillSummary(entryform_id);
    $("#show_summary").modal("show");
  });

  function fillSummary(entryform_id){
    var url = Urls.entryform_id(entryform_id);

    $.ajax({
      type: "GET",
      url: url,
      async: false,
    })
    .done(function (data) {
      var selectClient = '<select class="select2 form-control selectOpt" id="client" name="client" {% if not edit %}disabled{% endif %}>';
      $.each(data.customers_list, function(j, o){
          selectClient += '<option value="'+o.id+'">'+o.name+'</option>';
      });
      selectClient +='</select>';

      var selectFix = '<select class="select2 form-control selectOpt" id="fixative" name="fixative" {% if not edit %}disabled{% endif %}>';
      $.each(data.fixtatives_list, function(j, o){
          selectFix += '<option value="'+o.id+'">'+o.name+'</option>';
      });
      selectFix +='</select>';

      var selectSpecie = '<select class="select2 form-control selectOpt" id="specie" name="specie" {% if not edit %}disabled{% endif %}>';
      $.each(data.species_list, function(j, o){
          selectSpecie += '<option value="'+o.id+'">'+o.name+'</option>';
      });
      selectSpecie +='</select>';

      var selectlarvalstage = '<select class="select2 form-control selectOpt" id="larvalstage" name="larvalstage" {% if not edit %}disabled{% endif %}>';
      $.each(data.larvalStages_list, function(j, o){
          selectlarvalstage += '<option value="'+o.id+'">'+o.name+'</option>';
      });
      selectlarvalstage +='</select>';

      var selectwatersource = '<select class="select2 form-control selectOpt" id="watersource" name="watersource" {% if not edit %}disabled{% endif %}>';
      $.each(data.waterSources_list, function(j, o){
          selectwatersource += '<option value="'+o.id+'">'+o.name+'</option>';
      });
      selectwatersource +='</select>';

      $('.NoCasoSummary').html(data.entryform.no_caso);
      $('.summaryClient').html('<label>Cliente:</label>' + selectClient);
      $('.summaryCompany').html('<label>Empresa:</label> <input class="form-control" value="'+ data.entryform.company+'" name="company" {% if not edit %}disabled{% endif %} />');
      $('.summaryCenter').html('<label>Centro:</label> <input class="form-control" value="'+ data.entryform.center+'" name="center" {% if not edit %}disabled{% endif %} />');
      $('.summaryResponsible').html('<label>Responsable:</label> <input class="form-control" value="'+ data.entryform.responsible+'" name="responsable" {% if not edit %}disabled{% endif %} />');
      $('.summaryReception').html('<label>Fecha recepción:</label> <div class="input-group date" id=""><input type="text" class="form-control" name="recive" {% if not edit %}disabled{% endif %} value="'+ moment(data.entryform.created_at).format("DD/MM/YYYY HH:mm")+'" /><div class="input-group-append"><span class="input-group-text"><span class="fa fa-calendar"></span></span></div></div> ' );
      $('.sumarrySampling').html('<label>Fecha muestreo:</label> <div class="input-group date" id=""><input type="text" class="form-control" name="muestreo" {% if not edit %}disabled{% endif %} value="'+ moment(data.entryform.sampled_at).format("DD/MM/YYYY HH:mm")+'" /><div class="input-group-append"><span class="input-group-text"><span class="fa fa-calendar"></span></span></div></div> ' );
      $('.summaryNoOrder').html('<label>No. orden:</label> <input class="form-control" value="'+ data.entryform.no_order+'" name="no_order" {% if not edit %}disabled{% endif %} />');
      $('.summaryNoRequest').html('<label>No. solicitud:</label> <input class="form-control" value="'+ data.entryform.no_request+'" name="no_solic" {% if not edit %}disabled{% endif %} />');
      $('.summaryFixative').html('<label>Fijador:</label>'+ selectFix);
      
      $('.summarySpecie').html('<label>Especie:</label>'+selectSpecie  );
      $('.summaryDevStatus').html('<label>Estado de desarrollo:</label>'+selectlarvalstage ); 
      $('.summaryWaterSource').html('<label>Fuente de agua:</label>'+selectwatersource);

      // var tpl_identification = '';
      var tpl_identification ='<div class="col-sm-12"> <hr><h6 class="form-section mt-2"> Identificación</h6></br> </div>';

      $.each(data.entryform.identifications, function(i, item){
        var optimum = ""
        if (!item.is_optimum){
          optimum = "selected"
        }
        var selectOptimum = '<select class="select2 form-control selectOpt" name="optimo" {% if not edit %}disabled{% endif %} ><option value="1">Si</option><option value="0" '+optimum+'>No</option></select>'
        
        var selectOrgans = '<select class="select2 form-control selectOrgs" name="organs" multiple {% if not edit %}disabled{% endif %}>';
        $.each(data.organs, function(j, o){
          if(item.organs_set.findIndex(x => x.id === o.id) != -1){
            selectOrgans += '<option value="'+o.id+'" selected>'+o.name+'</option>';
          }
          else
            selectOrgans += '<option value="'+o.id+'">'+o.name+'</option>';
        });
        selectOrgans +='</select>';
        
        tpl_identification += '<div class="col-md-4"><form id="identification-'+item.id+'" action="#" method="POST">';
        tpl_identification += '<div class="alert alert-light"><div class="row">';
        tpl_identification += '<div class="form-group col-md-6"><label>Estanque/Jaula:</label> <input class="form-control" value="'+ item.cage+'"  name="jaula" {% if not edit %}disabled{% endif %} /></div>';
        tpl_identification += '<div class="form-group col-md-6"><label>Grupo:</label> <input class="form-control" value="'+ item.group+'"  name="grupo" {% if not edit %}disabled{% endif %} /></div>';
        tpl_identification += '<div class="form-group col-md-6"><label>Peces:</label> <input class="form-control" value="'+ item.no_fish+'" disabled {% if not edit %}disabled{% endif %} /></div>';
        tpl_identification += '<div class="form-group col-md-6"><label>Contenedores:</label> <input class="form-control" type="number" value="'+ item.no_container+'"  name="contenedores" {% if not edit %}disabled{% endif %} /></div>';
        tpl_identification += '<div class="form-group col-md-6"><label>Peso:</label> <input class="form-control" type="number" value="'+ item.weight+'"  name="peso" {% if not edit %}disabled{% endif %} /></div>';
        tpl_identification += '<div class="form-group col-md-6"><label>Óptimo?:</label>'+ selectOptimum+'</div>';
        tpl_identification += '<div class="form-group col-md-6"><label>Comentarios Extras:</label> <textarea class="form-control" rows="2" name="extras" {% if not edit %}disabled{% endif %} >'+ item.extra_features_detail+' </textarea></div>';
        tpl_identification += '<div class="form-group col-md-6"><label>Observaciones:</label> <textarea class="form-control" rows="2" name="observation" {% if not edit %}disabled{% endif %} >'+ item.observation+' </textarea></div>';
        tpl_identification += '<div class="form-group col-md-10"><label>Órganos:</label>'+selectOrgans+'</div>';
        {% if edit %}
        tpl_identification += '<div style="padding-top:25px;"><a href="javascript:void(0);" onclick="submitIdentification('+item.id+')" class="btn btn-primary"> <i class="fa fa-save"></i> </a></div>'
        {% endif %}
        tpl_identification += '</div></div>';
        tpl_identification += '</form></div>';
      });

      // tpl_identification += '</div>';
      $('.summaryIdentification').html(tpl_identification);

      var tpl_exams = '<div class="col-sm-12"><h6 class="form-section mt-2"> Servicios</h6></br>';
      $.each(data.entryform.analyses, function(i, item){
        tpl_exams += '<div class="alert alert-light"><b>'+ item.exam__name +'</b> <b class="pull-right">'
        if(item.patologo__first_name != null)
          tpl_exams += item.patologo__first_name+' ';
        if(item.patologo__last_name != null)
          tpl_exams += item.patologo__last_name;
        tpl_exams += '</b> <br>'+ moment(item.created_at).format("DD/MM/YYYY HH:mm") +'</div>';
      });

      tpl_exams += '</div>';
      $('.summaryExams').html(tpl_exams);

      var tpl_samples = '<div class="col-sm-12"><h6 class="form-section mt-2"> Muestras</h6></br><table class="table table-bordered table-xs">';
      tpl_samples += '<thead><tr><th width="8% !important;">Muestra</th><th>Identificación</th><th>Análisis</th><th>Órganos</th></tr></thead><tbody>';
      var patologos = {};
      $.each(data.patologos, function(i, v){
        patologos[v.id]=v.first_name+' '+v.last_name;
      })
      
      $.each(data.samples, function(i, item){
        var len = 1;
        var tpl_exams = ""
        $.each(item.sample_exams_set, function(j, v){
          len+=1;
          tpl_exams += '<tr><td>'+v.exam_name+'</td>';
          tpl_exams += '<td>'+ Object.keys(v.organ_id).map(function(k){return v.organ_id[k].name}).join(", ") +'</td>';
        });
        tpl_samples += '<tr>';
        tpl_samples += '<td rowspan="'+len+'">'+ item.index +'</td>';
        tpl_samples += '<td rowspan="'+len+'">'+ item.identification.cage +'-'+item.identification.group+'</td>';
        tpl_samples += '</tr>';
        tpl_samples += tpl_exams;
        
      });

      tpl_samples += '</tbody></table></div>';
      $('.summarySamples').html(tpl_samples);

      $('#client').val(data.entryform.customer.id);
      $('#fixative').val(data.entryform.fixative.id);
      $('#specie').val(data.entryform.specie.id);
      $('#watersource').val(data.entryform.watersource.id);
      $('#larvalstage').val(data.entryform.larvalstage.id);

      $('.selectOpt').select2({'width':'100%'});
      $('.selectOrgs').select2({'width':'100%'});
      
      $('.date').datetimepicker({
          locale: 'es',
          keepOpen: false,
          format:'DD/MM/YYYY HH:mm'
        });
    });

  }
  
  function submitGeneralData(){
  var data = $('#generalData').serialize();
  $.ajax({
    type: "POST",
    url: '/generalData/'+resumenId,
    data: data,
    async: false,
  })
  .done(function (data) {
    $('#show_summary').modal('hide');
  })
  .fail(function (data) {
    console.log("Fail");
  })

}

</script> {% endblock scripts %}
