{% extends 'layout.html' %}
{% load static %}
{% block stylesheets %}

<style>
  .steps {
    pointer-events: none;
  }
</style>

{% endblock stylesheets %}
{% block content_header %}
<div class="content-header row">
  <div class="content-header-left col-md-6 col-12 mb-2">
    <h3 class="content-header-title mb-0">Ingreso</h3>
    <div class="row breadcrumbs-top">
      <div class="breadcrumb-wrapper col-12">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/">INICIO</a>
          </li>
          <li class="breadcrumb-item">
            <a href="#">CASOS</a>
          </li>
          <li class="breadcrumb-item active">
            {{form.content_object.no_caso}}
          </li>
        </ol>
      </div>
    </div>
  </div>
</div>
{% endblock content_header %}
{% block content %}<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <center>
          <h3> <strong>CASO N° {{form.content_object.no_caso}}</strong></h3>
          <button class="btn btn-secondary square showSummaryBtn hidden"><i class="fa fa-list fa-fx"></i> Resúmen del caso</button>
          <button class="btn btn-secondary square newAnalysisBtn hidden"><i class="fa fa-list fa-plus-circle"></i> Nuevo Análisis</button>
        </center>
      </div>
      <div class="card-content">
        <div class="card-body">
          <form action="#" id="workflow_form" class="wizard-circle">
            {% for step in form.flow.step_set.all %}
              <h6>{{ step.name }}</h6>
              {% include step.route|add:".html" with step_tag=step.tag step_id=step.pk form_id=form_id entryform_id=entryform_id step_tab=forloop.counter0 %}
            {% endfor %}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade text-left" id="show_summary" role="dialog">
  <div class="modal-dialog" role="document" style="min-width:80% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="title">Resúmen Caso <span class="NoCasoSummary"></span></h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="font-size:12px !important; max-height: calc(100vh - 150px); overflow-y:scroll;">
        
        <h6 class="form-section"> Información general</h6>
        <div class="row generalInfo">
          <div class="col-sm-4 summaryClient">
          </div>
          <div class="col-sm-4 summaryCompany">
          </div>
          <div class="col-sm-4 summaryCenter">
          </div>
          <div class="col-sm-4 summaryResponsible">
          </div>
          <div class="col-sm-4 summaryReception">
          </div>
          <div class="col-sm-4 sumarrySampling">
          </div>
          <div class="col-sm-4 summaryNoOrder">
          </div>
          <div class="col-sm-4 summaryNoRequest">
          </div>
          <div class="col-sm-4 summaryFixative">
          </div>
        </div>
        <hr>
        <h6 class="form-section mt-2"> Detalle</h6>
        <div class="row ">
          <div class="col-sm-4 summarySpecie">
          </div>
          <div class="col-sm-4 summaryDevStatus">
          </div>
          <div class="col-sm-4 summaryWaterSource">
          </div>
        </div>
        <hr>
        <h6 class="form-section mt-2"> Identificación</h6>
        <div class="row summaryIdentification">
        </div>
        <hr>
        <h6 class="form-section mt-2"> Muestras</h6>
        <div class="row summarySamples">
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}
{% block scripts %}
<script src="{% url 'js_reverse' %}" type="text/javascript"></script>
{% for step in form.flow.step_set.all %}
  {% with step.route|add:".js" as script_step %}
    <script src="{% static script_step %}" type="text/javascript"></script>
  {% endwith %}
{% endfor %}

<script type="text/javascript">

var form = $("#workflow_form");
var saltar=false;
var steps = $("#workflow_form").steps({
    headerTag: "h6",
    bodyTag: "fieldset",
    transitionEffect: "fade",
    titleTemplate: '<span class="step">#index#</span> #title#',
    labels: {
        previous: 'Deshacer y Volver',
        next: 'Continuar',
        finish: 'Finalizar'
    },
    startIndex: 0,
    onStepChanging: function (events, currentIndex, newIndex)
    {
      if(!set_state) {
        var previous_step = false;
        var form_data;

        if (currentIndex == 0){
          var resp = validate_step_1();
          if (!resp) {
            return false
          }
        } else if (currentIndex == 1) {
          var resp = validate_step_2();
          if (!resp) {
            return false
          }
        } else if (currentIndex == 2) {
          var resp = validate_step_3();
          if (!resp) {
            return false
          }
        }
        
        if (currentIndex > newIndex)
        {
          previous_step = true;
          var disform = $("#step_" + newIndex + " :input").find(':disabled').prop('disabled', false);
          form_data = $("#step_" + newIndex + " :input").serialize();
          disform.prop('disabled', true);
        } else {
          previous_step = false;
          var disform = $("#step_" + currentIndex + " :input").find(':disabled').prop('disabled', false);
          form_data = $("#step_" + currentIndex + " :input").serialize();
          disform.attr('disabled', true);
        }
        
        var url = Urls.workflow();
        var id_next_step = $("#step_" + newIndex).children("#step_id").val();

        var response;
        $.ajax({
          type: "POST",
          url: url,
          data: form_data + "&id_next_step=" + id_next_step +"&previous_step=" + previous_step,
          async: false,
        })
        .done(function (data) {
          response = data;
        })
        .fail(function (data) {
          console.log("Fail");
        })

        if (response.next_step_permission) {
          var step;
          var function_name;
          if(previous_step) {
            step = currentIndex
            function_name = "init_step_" + step;

          } else {
            step = newIndex + 1
            function_name = "init_step_" + step;
          }
          window[function_name]();
        } else {
          toastr.error('No puedes continuar ya que no tienes permisos para los siguientes pasos.', 'No tienes permisos');
          setTimeout(function() {
            window.location.href = '/ingresos'
          }, 1000);
        }

        if(!previous_step) {
          if(response.process_response) {
            toastr.success('', 'Paso guardado exitosamente!');
          }
        }

        return response.next_step_permission;
      } else {
        set_state = false;
        return true
      }
    },
    onStepChanged:function (event, currentIndex, prevIndex){
      if(currentIndex < prevIndex){
          if (prevIndex == 5){
              if(saltar){
                  steps.steps("previous");
              }
          }
          else if (prevIndex == 4){
              if(saltar){
                  steps.steps("previous");
              }
          }
          else if (prevIndex == 3){
              if(saltar){
                  steps.steps("previous");
              }
          }
          return true; 
      }
      if (currentIndex == 2){
          if(saltar){
              steps.steps("next");
          }
      }
      else if (currentIndex == 3){
          if(saltar){
              steps.steps("next");
          }
      }
      else if (currentIndex == 4){
          if(saltar){
              steps.steps("next");
          }
      }
      return true; 
    }, 
    onFinishing: function (event, currentIndex)
    {
      alert(1);
        // form.validate().settings.ignore = ":disabled";
        // return form.valid();
    },
    onFinished: function (event, currentIndex)
    {
      event.preventDefault();
      var url = Urls.entryform();
      var disform = $("form").find(':disabled').prop('disabled', false);
      var form_data = ($("form").serialize());
      disform.prop('disabled', true);

      $.ajax({
        type: "POST",
        url: url,
        data: form_data,
      })
      .done(function () {
      alert(2);

      })
      .fail(function () {
        console.log("Fail")
      })
    }
});

$(window).on('load', function (e) {
    // If para cargar un paso en especifico
  {% if set_step_tag and set_step_tag != "step_1" %}
    set_state = true;
    var step_wizard = parseInt("{{ set_step_tag }}".split("_")[1]) - 1; // Se resta 1 para igualar a los indices del plugin
    var step_tag_function = "init_{{ set_step_tag }}";

    form.steps("setStep", step_wizard);

    window[step_tag_function]();

  {% else %}
    set_state = false;

    // Si se abre un nuevo caso es necesario ejecutar el metodo del paso 1
    init_step_1();
  {% endif %}
});

$(document).on('click', '.showSummaryBtn', function(e){
  $("#show_summary").modal("show");
});

$(document).on('click', '.newAnalysisBtn', function(e){
  {% if set_step_tag and set_step_tag == "step_4" %}
    $("#new_analysis").modal("show");
  {% else %}
    $("#new_analysis5").modal("show");
  {% endif %}
});

function fillSummary(data){
  $('.NoCasoSummary').html(data.entryform.no_caso);
  $('.summaryClient').html('<b>Cliente</b>: '+ data.entryform.customer.name);
  $('.summaryCompany').html('<b>Empresa</b>: '+ data.entryform.company);
  $('.summaryCenter').html('<b>Centro</b>: '+ data.entryform.center);
  $('.summaryResponsible').html('<b>Responsable</b>: '+ data.entryform.responsible);
  $('.summaryReception').html('<b>Fecha recepción</b>: '+ moment(data.entryform.created_at).format("DD/MM/YYYY HH:MM") );
  $('.sumarrySampling').html('<b>Fecha muestreo</b>: '+ moment(data.entryform.sampled_at).format("DD/MM/YYYY HH:MM") );
  $('.summaryNoOrder').html('<b>No. orden</b>: '+ data.entryform.no_order);
  $('.summaryNoRequest').html('<b>No. solicitud</b>: '+ data.entryform.no_request);
  $('.summaryFixative').html('<b>Fijador</b>: '+ data.entryform.fixative.name);
  
  $('.summarySpecie').html('<b>Especie</b>: '+ data.entryform.specie.name);  
  $('.summaryDevStatus').html('<b>Estado de desarrollo</b>: '+ data.entryform.larvalstage.name);  
  $('.summaryWaterSource').html('<b>Fuente de agua</b>: '+ data.entryform.watersource.name);

  var tpl_identification = '<div class="col-sm-12"><table class="table table-bordered table-xs">';
  tpl_identification += '<thead><tr><th>Estanque/Jaula</th><th>Grupo</th><th>Peces</th><th>Contenedores</th><th>Peso</th><th>C. Extras</th><th>Óptimo</th><th>Obs</th><th>Órganos</th></tr></thead><tbody>';

  $.each(data.entryform.identifications, function(i, item){
    var optimum = "No"
    if (item.is_optimum){
      optimum = "Sí"
    }
    tpl_identification += '<tr>';
    tpl_identification += '<td>'+ item.cage +'</td>';
    tpl_identification += '<td>'+ item.group +'</td>';
    tpl_identification += '<td>'+ item.no_fish +'</td>';
    tpl_identification += '<td>'+ item.no_container +'</td>';
    tpl_identification += '<td>'+ item.weight +'</td>';
    tpl_identification += '<td>'+ item.extra_features_detail +'</td>';
    tpl_identification += '<td>'+ optimum +'</td>';
    tpl_identification += '<td>'+ item.observation +'</td>';
    tpl_identification += '<td>'+ Object.keys(item.organs_set).map(function(k){return item.organs_set[k].name}).join(", ") +'</td>';
    tpl_identification += '</tr>';
  });

  tpl_identification += '</tbody></table></div>';
  $('.summaryIdentification').html(tpl_identification);

  var tpl_samples = '<div class="col-sm-12"><table class="table table-bordered table-xs">';
  tpl_samples += '<thead><tr><th>No. Muestra</th><th>Identificación</th><th>Análisis</th><th>Órganos</th></tr></thead><tbody>';

  $.each(data.samples, function(i, item){
    var len = 1;
    var tpl_exams = ""
    $.each(item.sample_exams_set, function(j, v){
      len+=1;
      tpl_exams += '<tr><td>'+v.exam_name+'</td>';
      tpl_exams += '<td>'+ Object.keys(v.organ_id).map(function(k){return v.organ_id[k].name}).join(", ") +'</td></tr>';
    });
    tpl_samples += '<tr>';
    tpl_samples += '<td rowspan="'+len+'">'+ item.index +'</td>';
    tpl_samples += '<td rowspan="'+len+'">'+ item.identification.cage +'-'+item.identification.group+'</td>';
    // tpl_samples += '<td></td>';
    // tpl_samples += '<td></td>';
    tpl_samples += '</tr>';
    tpl_samples += tpl_exams;
    
  });

  tpl_samples += '</tbody></table></div>';
  $('.summarySamples').html(tpl_samples);

}

</script> {% endblock scripts %}
