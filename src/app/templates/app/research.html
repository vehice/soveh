{% extends 'layout.html' %}
{% load static %}
{% block stylesheets %}

<style>

  .dt-body-center{
    text-align: center;
    padding:6px !important;
    margin:6px !important;
  }

</style>

{% endblock stylesheets %}
{% block content_header %}
<div class="content-header row">
  <div class="content-header-left col-md-6 col-12 mb-2">
    <h3 class="content-header-title mb-0">Configuración de Estudio</h3>
    <div class="row breadcrumbs-top">
      <div class="breadcrumb-wrapper col-12">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/">Home</a>
          </li>
          <li class="breadcrumb-item">
            <a href="#">Estudios</a>
          </li>
        </ol>
      </div>
    </div>
  </div>
  {% comment %} <div class="content-header-right col-md-6 col-12">
    <div class="float-md-right">
      {% if can_edit %}
      <button class="btn btn-success btn-lg round" id="add_new_research">
        <i class="fa fa-plus"></i>
        Nuevo Estudio
      </button>
      {% endif %}
    </div>
  </div> {% endcomment %}
</div>
{% endblock content_header %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-content">
        <div class="card-body card-dashboard">
          <p><h1>Estudio {{research.code}} {{research.name.title}} </h1></p>

          <div class="row">
            <div class="col-md-12">
              
              
              <center><div class="badge badge-warning"><h3>ANÁLISIS DISPONIBLES</h3></div></center>

              <div class="row mt-3 pl-3">
                <div class="col-md-2">
                  <div id="filter1-year">
                  </div>
                </div>
                <div class="col-md-2">
                  <div id="filter1-month">
                  </div>
                </div>
              </div>

              <table id="table-casos" class="table table-striped table-bordered compact dataTable" width="100%">
                <thead>
                  <tr>
                    <th>Nro<br>Caso</th>
                    <th>Cliente</th>
                    <th>Servicios</th>
                    <th>Fecha<br>Ingreso<br>Servicio</th>
                    <th>Fecha<br>Muestreo</th>
                    <th></th>
                    <th></th>
                    <th>Estado<br>Servicio</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for entryForm in casos1 %}
                    <tr>
                      <td class="first-column"><strong>{{ entryForm.no_caso }}</strong></td>
                      <td>
                          {{ entryForm.cliente }}
                      </td>
                      <td>{{ entryForm.exam|default:"" }}</td>
                      <td>
                          {{ entryForm.fecha_ingreso|default:"--" }}
                      </td>
                      <td>
                          {{ entryForm.fecha_muestreo|default:"--" }}
                      </td>
                      <td>
                          {{ entryForm.f_m_year|default:"--" }}
                      </td>
                      <td>
                          {{ entryForm.f_m_month|default:"--" }}
                      </td>
                      <td>
                          {{ entryForm.estado }}
                      </td>
                      <td>
                        <div class="btn-group optionGroups-{{entryForm.analisis}}" data-entryform="{{ entryForm.entryform }}" role="group">
                          
                          <button 
                            class="btn btn-primary showSummaryBtn" 
                            data-id="{{ entryForm.entryform }}" 
                            data-closed="{% if entryForm.entryform_form_closed or entryForm.entryform_cancelled %} 1 {% else %} 0 {% endif %}" 
                            data-toggle="tooltip" 
                            data-placement="top" 
                            title="Resúmen del Caso">
                            <i class="fa fa-list-alt fa-fx"></i> Ver Caso
                          </button>
                          
                          <button 
                            class="btn btn-success addAnalysis"
                            data-analysis-id="{{entryForm.analisis}}"
                            data-toggle="tooltip" 
                            data-placement="top" 
                            title="Ingresar al Estudio">
                            <i class="fa fa-plus fa-fx"></i> Ingresar
                          </button>

                        </div>

                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <div class="col-md-12 mt-3">

              <center><div class="badge badge-success"><h3>ANÁLISIS AGREGADOS </h3></div></center>

              <div class="row mt-3 pl-3">
                <div class="col-md-2">
                  <div id="filter2-year">
                  </div>
                </div>
                <div class="col-md-2">
                  <div id="filter2-month">
                  </div>
                </div>
              </div>
              
              <table id="table-casos2" class="table table-striped table-bordered compact dataTable" width="100%">
                <thead>
                  <tr>
                    <th>Nro<br>Caso</th>
                    <th>Cliente</th>
                    <th>Servicios</th>
                    <th>Fecha<br>Ingreso<br>Servicio</th>
                    <th>Fecha<br>Muestreo</th>
                    <th></th>
                    <th></th>
                    <th>Estado<br>Servicio</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for entryForm in casos2 %}
                    <tr>
                      <td class="first-column"><strong>{{ entryForm.no_caso }}</strong></td>
                      <td>
                          {{ entryForm.cliente }}
                      </td>
                      <td>{{ entryForm.exam|default:"" }}</td>
                      <td>
                          {{ entryForm.fecha_ingreso }}
                      </td>
                      <td>
                          {{ entryForm.fecha_muestreo }}
                      </td>
                      <td>
                          {{ entryForm.f_m_year|default:"--" }}
                      </td>
                      <td>
                          {{ entryForm.f_m_month|default:"--" }}
                      </td>
                      <td>
                          {{ entryForm.estado }}
                      </td>
                      <td>
                        <div class="btn-group optionGroups-{{entryForm.analisis}}" data-entryform="{{ entryForm.entryform }}" role="group">
                          <button 
                            class="btn btn-primary showSummaryBtn" 
                            data-id="{{ entryForm.entryform }}" 
                            data-closed="{% if entryForm.entryform_form_closed or entryForm.entryform_cancelled %} 1 {% else %} 0 {% endif %}" 
                            data-toggle="tooltip" 
                            data-placement="top" 
                            title="Resúmen del Caso">
                            <i class="fa fa-list-alt fa-fx"></i> Ver Caso
                          </button>
                          
                          <button 
                            class="btn btn-danger removeAnalysis"
                            data-analysis-id="{{entryForm.analisis}}"
                            data-toggle="tooltip" 
                            data-placement="top" 
                            title="Quitar del Estudio">
                            <i class="fa fa-close fa-fx"></i> Quitar
                          </button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="col-md-12 mt-3 text-right">
              <a href="/estudios" class="btn btn-lg btn-danger">Salir sin guardar</a>
              <button class="btn btn-lg btn-info" onclick="saveResearch(1);">Guardar y salir</button>
              <button class="btn btn-lg btn-success" onclick="saveResearch(2);">Guardar</button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade text-left" id="show_summary" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog" role="document" style="min-width:90% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="title">Resumen Caso <span class="NoCasoSummary"></span></h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="font-size:12px !important; max-height: calc(100vh - 150px); overflow-y:scroll;">
        <div style="padding: 10px;background-color: #f2efed;">
          {% if edit %}
          <div class="col-md-12">
            <a href="javascript:void(0);" id="btn_save" onclick="submitGeneralData()" class="btn btn-primary pull-right"> <i class="fa fa-save fa-2x"></i> </a>
          </div>
          {% endif %}
          <form action="#" id="generalData">
            <h6 class="form-section mt-2">  <b>Información general</b></h6>
            <div class="row generalInfo">
              <div class="col-sm-4 form-group summaryClient">
              </div>
              <div class="col-sm-4 form-group summaryCompany">
              </div>
              <div class="col-sm-4 form-group summaryCenter">
              </div>
              <div class="col-sm-4 form-group summaryResponsible">
              </div>
              <div class="col-sm-4 form-group summaryReception">
              </div>
              <div class="col-sm-4 form-group sumarrySampling">
              </div>
              <div class="col-sm-4 form-group summaryNoOrder">
              </div>
              <div class="col-sm-4 form-group summaryNoRequest">
              </div>
              <div class="col-sm-4 form-group summaryFixative">
              </div>
              <div class="col-sm-12 form-group summaryAnamnesis">
              </div>
              <div class="col-sm-4 form-group summaryEntryformType">
              </div>
              <div class="col-sm-4 form-group summaryTransferOrder">
              </div>
            </div>
            <hr>
            <h6 class="form-section mt-2"> <b>Detalle</b></h6>
            <div class="row ">
              <div class="col-sm-4 summarySpecie">
              </div>
              <div class="col-sm-4 summaryDevStatus">
              </div>
              <div class="col-sm-4 summaryWaterSource">
              </div>
            </div>
          </form>   
        </div>
        <div class="row">
          <div class="row col-sm-12 summaryIdentification" style="margin:0">
          </div>
          <div class="col-sm-5 summaryExams">
          </div>
          <div class="col-sm-7 summarySamples">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %} {% block scripts %}

<script type="text/javascript">
  var resumenId;
  var closed;
  var tabla_casos;
  var tabla_casos2;
  
  $(document).on('click', '.showSummaryBtn', function(e){
    var entryform_id = $(this).data('id');
    closed = parseInt($(this).data('closed'));
    resumenId = entryform_id;
    getSummaryData();
  });

  function getSummaryData(){
    var entryform_id = resumenId;
    var closed = closed;
    var url = Urls.entryform_id(entryform_id);
    $.ajax({
      type: "GET",
      url: url,
    })
    .done(function (data) {
      fillSummary(data);
      if(closed == 1){
        $('#btn_save').hide();
        $('.btn-save-identification').hide();
      }
      else{
        $('#btn_save').show();
        $('.btn-save-identification').show();
      }
      $("#show_summary").modal("show");
    })
    .fail(function () {
      console.log("Fail")
    });
  }

  function fillSummary(data){
    var selectClient = '<select class="select2 form-control selectOpt" id="client" name="client" {% if not edit or closed  %}disabled{% endif %} >';
    $.each(data.customers_list, function(j, o){
        selectClient += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectClient +='</select>';

    var selectFix = '<select class="select2 form-control selectOpt" id="fixative" name="fixative" {% if not edit or closed  %}disabled{% endif %} >';
    $.each(data.fixtatives_list, function(j, o){
        selectFix += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectFix +='</select>';

    var selectEntryformType = '<select class="select2 form-control selectOpt" id="entryform_type" name="entryform_type" {% if not edit or closed  %}disabled{% endif %} >';
    $.each(data.entryform_types_list, function(j, o){
        selectEntryformType += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectEntryformType +='</select>';

    var selectSpecie = '<select class="select2 form-control selectOpt" id="specie" name="specie" {% if not edit or closed  %}disabled{% endif %} >';
    $.each(data.species_list, function(j, o){
        selectSpecie += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectSpecie +='</select>';

    var selectlarvalstage = '<select class="select2 form-control selectOpt" id="larvalstage" name="larvalstage" {% if not edit or closed  %}disabled{% endif %} >';
    $.each(data.larvalStages_list, function(j, o){
        selectlarvalstage += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectlarvalstage +='</select>';

    var selectwatersource = '<select class="select2 form-control selectOpt" id="watersource" name="watersource" {% if not edit or closed  %}disabled{% endif %} >';
    $.each(data.waterSources_list, function(j, o){
        selectwatersource += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectwatersource +='</select>';

    $('.NoCasoSummary').html(data.entryform.no_caso);
    $('.summaryClient').html('<label>Cliente:</label>' + selectClient);
    $('.summaryCompany').html('<label>Empresa:</label> <input class="form-control" value="'+ data.entryform.company+'" name="company" {% if not edit or closed %}disabled{% endif %} />');
    $('.summaryCenter').html('<label>Centro:</label> <input class="form-control" value="'+ data.entryform.center+'" name="center" {% if not edit or closed  %}disabled{% endif %} />');
    $('.summaryTransferOrder').html('<label>Orden de transporte:</label> <input class="form-control" value="'+ data.entryform.transfer_order+'" name="transfer_order" />');
    $('.summaryResponsible').html('<label>Responsable:</label> <input class="form-control responsible_place" readonly value="'+ data.entryform.responsible+'" name="responsable" onclick="responsibleModal()" {% if not edit or closed  %}disabled{% endif %} />');
    $('.summaryReception').html('<label>Fecha recepción:</label> <div class="input-group date" id=""><input type="text" class="form-control" name="recive" value="'+ moment(data.entryform.created_at).format("DD/MM/YYYY HH:mm")+'" {% if not edit or closed  %}disabled{% endif %} /><div class="input-group-append"><span class="input-group-text"><span class="fa fa-calendar"></span></span></div></div> ' );
    $('.sumarrySampling').html('<label>Fecha muestreo:</label> <div class="input-group date" id=""><input type="text" class="form-control" name="muestreo" value="'+ moment(data.entryform.sampled_at).format("DD/MM/YYYY HH:mm")+'" {% if not edit or closed  %}disabled{% endif %} /><div class="input-group-append"><span class="input-group-text"><span class="fa fa-calendar"></span></span></div></div> ' );
    $('.summaryNoOrder').html('<label>Nro Orden de Trabajo:</label> <input class="form-control" value="'+ data.entryform.no_order+'" name="no_order" {% if not edit or closed  %}disabled{% endif %} />');
    $('.summaryNoRequest').html('<label>Nro Solicitud Interlaboratorio:</label> <input class="form-control" value="'+ data.entryform.no_request+'" name="no_solic" {% if not edit or closed  %}disabled{% endif %} />');
    $('.summaryAnamnesis').html('<label>Anamnesis:</label> <textarea class="form-control" row="2" name="anamnesis" {% if not edit %}disabled{% endif %} >'+ data.entryform.anamnesis+'</textarea>');
    $('.summaryFixative').html('<label>Fijador:</label>'+ selectFix);
    $('.summaryEntryformType').html('<label>Tipo de Ingreso:</label>'+ selectEntryformType);
    $('.summarySpecie').html('<label>Especie:</label>'+selectSpecie  );
    $('.summaryDevStatus').html('<label>Estadío Desarrollo:</label>'+selectlarvalstage ); 
    $('.summaryWaterSource').html('<label>Fuente de agua:</label>'+selectwatersource);

    // var tpl_identification = '';
    var tpl_identification = '<div class="col-sm-12"> <hr><h6 class="form-section mt-2"> <b>Identificación</b> &nbsp;&nbsp;&nbsp;';
    {% if edit and not closed %}
      tpl_identification += '<a href="javascript:void(0);" onclick="newIdentification('+data.entryform.id+')" class="btn btn-secondary btn-sm"> <i class="fa fa-plus"></i> Agregar Identificación</a>'
    {% endif %}
    tpl_identification += '</h6></div>';

    $.each(data.entryform.identifications, function(i, item){
      var optimum = ""
      if (!item.is_optimum){
        optimum = "selected"
      }
      var selectOptimum = '<select class="select2 form-control selectOpt" name="optimo" {% if not edit or closed  %}disabled{% endif %} ><option value="1">Si</option><option value="0" '+optimum+'>No</option></select>'
      
      var selectOrgans = '<select class="select2 form-control selectOrgs" name="organs" multiple {% if not edit or closed  %}disabled{% endif %} >';

      $.each(data.organs, function(j, o){
        if(item.organs_bv_set.findIndex(x => x.id === o.id) != -1){
          selectOrgans += '<option value="'+o.id+'" selected>'+o.name+'</option>';
        }
        else
          selectOrgans += '<option value="'+o.id+'">'+o.name+'</option>';
      });
      selectOrgans +='</select>';
      
      tpl_identification += '<div class="col-md-4"><form id="identification-'+item.id+'" action="#" method="POST">';
      tpl_identification += '<div class="alert alert-light"><div class="row">';
      tpl_identification += '<div class="form-group col-md-6"><label>Estanque/Jaula:</label> <input class="form-control" value="'+ item.cage+'"  name="jaula" {% if not edit or closed  %}disabled{% endif %} /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Grupo/Nro Caso Cliente:</label> <input class="form-control" value="'+ item.group+'"  name="grupo" {% if not edit or closed  %}disabled{% endif %} /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Peces:</label> <input class="form-control just_increasing" name="no_fish" data-val="'+ item.no_fish+'" value="'+ item.no_fish+'" {% if not edit or closed  %}disabled{% endif %} /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Contenedores:</label> <input class="form-control" type="number" value="'+ item.no_container+'"  name="contenedores" {% if not edit or closed  %}disabled{% endif %} /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Peso (gramos):</label> <input class="form-control" type="number" value="'+ item.weight+'"  name="peso" {% if not edit or closed  %}disabled{% endif %} /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Óptimo?:</label>'+ selectOptimum+'</div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Características Extras:</label> <textarea class="form-control" rows="2" name="extras" {% if not edit or closed  %}disabled{% endif %} >'+ item.extra_features_detail+' </textarea></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Observaciones:</label> <textarea class="form-control" rows="2" name="observation" {% if not edit or closed  %}disabled{% endif %} >'+ item.observation+' </textarea></div>';
      tpl_identification += '<div class="form-group col-md-9"><label>Órganos:</label>'+selectOrgans+'</div>';
      {% if edit and not closed %}
        tpl_identification += '<div style="padding-top:25px;"><a href="javascript:void(0);" onclick="submitIdentification('+item.id+')" class="btn btn-primary"> <i class="fa fa-save"></i></a>';
        if (item.removable){
          tpl_identification += '<a href="javascript:void(0);" onclick="removeIdentification('+item.id+')" class="btn btn-danger"> <i class="fa fa-trash"></i></a>';
        }
        tpl_identification += '</div>';
      {% endif %}
      tpl_identification += '</div></div>';
      tpl_identification += '</form></div>';
    });

    // tpl_identification += '</div>';
    $('.summaryIdentification').html(tpl_identification);

    var tpl_exams = '<div class="col-sm-12"><h6 class="form-section mt-2"> <b>Servicios</b></h6></br>';
    $.each(data.entryform.analyses, function(i, item){
      tpl_exams += '<div class="alert alert-light"><b>'+ item.exam__name +' (Tinción: '+item.stain+')</b> <span class="pull-right">'
      if(item.patologo__first_name != null)
        tpl_exams += '<b>Patólogo:</b> '+item.patologo__first_name+' ';
      if(item.patologo__last_name != null)
        tpl_exams += item.patologo__last_name;
      tpl_exams += '</span> <br> <b>Fecha: </b>'+ moment(item.created_at).format("DD/MM/YYYY HH:mm");
      tpl_exams += '</span> <br> <b>Estado: </b>'+ item.status;
      tpl_exams += '</span> <br> <b>Muestras a cobrar: </b>'+ item.samples_count;
      tpl_exams += '</span> <br> <b>Total órganos: </b>'+ item.organs_count;

      
      if (item.service_comments.length > 0) {
        tpl_exams += '<br> <b>Comentarios:</b><br><br>';
        $.each(item.service_comments, function(j, item2){
          tpl_exams += '<p style="margin-left: 5%;"><b>'+item2.done_by+' ('+item2.created_at+'):</b> <br> '+item2.text+'</p>'
        });
      }

      tpl_exams += '</div>';
    });

    tpl_exams += '</div>';
    $('.summaryExams').html(tpl_exams);

    var tpl_samples = '<div class="col-sm-12"><h6 class="form-section mt-2"> <b>Muestras</b></h6></br><table class="table table-bordered table-xs">';
    tpl_samples += '<thead><tr><th>Pez</th><th>Identificación</th><th>Análisis</th><th>Tinción</th><th>Órganos</th></tr></thead><tbody>';
    var patologos = {};
    $.each(data.patologos, function(i, v){
      patologos[v.id]=v.first_name+' '+v.last_name;
    })
    
    $.each(data.samples, function(i, item){
      var len = 1;
      var tpl_exams = ""
      $.each(item.sample_exams_set, function(j, v){
        len+=1;
        tpl_exams += '<tr><td>'+v.exam_name+'</td>';
        tpl_exams += '<td>'+v.sample_stain_abbr+'</td>';
        tpl_exams += '<td>'+ Object.keys(v.organ_id).map(function(k){return v.organ_id[k].name}).join(", ") +'</td></tr>';
      });
      tpl_samples += '<tr id="sample-id-'+item.id+'">';
      {% if edit and not closed %}
        tpl_samples += '<td rowspan="'+len+'"><button type="button" class="btn btn-sm btn-danger round" onclick="deleteSample('+item.id+');">X</button> '+ item.index +'</td>';
      {% else %}
        tpl_samples += '<td rowspan="'+len+'">'+ item.index +'</td>';
      {% endif %}
      tpl_samples += '<td rowspan="'+len+'">'+ item.identification.cage +'-'+item.identification.group+'</td>';
      tpl_samples += '</tr>';
      tpl_samples += tpl_exams;
      
    });

    tpl_samples += '</tbody></table></div>';
    $('.summarySamples').html(tpl_samples);

    if (data.entryform.customer != null) {
      $('#client').val(data.entryform.customer.id);
    }
  
    if (data.entryform.entryform_type != null) {
      $('#entryform_type').val(data.entryform.entryform_type.id);
    }
    if (data.entryform.fixative != null) {
      $('#fixative').val(data.entryform.fixative.id);
    }
    if (data.entryform.specie != null) {
      $('#specie').val(data.entryform.specie.id);
    }
    if (data.entryform.watersource != null) {
      $('#watersource').val(data.entryform.watersource.id);
    }
    if (data.entryform.larvalstage != null) {
      $('#larvalstage').val(data.entryform.larvalstage.id);
    }

    $('.selectOpt').select2({'width':'100%'});
    $('.selectOrgs').select2({'width':'100%'});
    
    $('.date').datetimepicker({
      locale: 'es',
      keepOpen: false,
      format:'DD/MM/YYYY HH:mm'
    });

    // $('#datetime_sampled_at').datetimepicker({
    //     locale: 'es',
    //     keepOpen: false,
    //     format:'DD/MM/YYYY HH:mm'
    //   });
  }
  
  function submitGeneralData(){
    swal({
      title: "Confirmación",
      text: "¿Está seguro que desea guardar los cambios?",
      icon: "warning",
      showCancelButton: true,
      buttons: {
        cancel: {
            text: "No, cancelar!",
            value: null,
            visible: true,
            className: "btn-warning",
            closeModal: true,
        },
        confirm: {
            text: "Sí!",
            value: true,
            visible: true,
            className: "",
            closeModal: true,
        }
      }
    }).then(isConfirm => {
      if (isConfirm) {
        var data = $('#generalData').serialize();
        $.ajax({
          type: "POST",
          url: '/generalData/'+resumenId,
          data: data,
          async: false,
        })
        .done(function (data) {
          $('#show_summary').modal('hide');
        })
        .fail(function (data) {
          console.log("Fail");
        })
      }
    });
  }

  function newIdentification(entryform_id){
    var url = Urls.new_identification(entryform_id);
    $.ajax({
      type: "GET",
      url: url,
    })
    .done(function (data) {
      if (data.ok){
        getSummaryData();
      }
    })
    .fail(function () {
      console.log("Fail")
    });
  }

  function removeIdentification(id){
    var url = Urls.remove_identification(id);
    $.ajax({
      type: "GET",
      url: url,
    })
    .done(function (data) {
      if (data.ok){
        getSummaryData();
      }
    })
    .fail(function () {
      console.log("Fail")
    });
  }

  function submitGeneralData(){
    swal({
      title: "Confirmación",
      text: "¿Está seguro que desea guardar los cambios?",
      icon: "warning",
      showCancelButton: true,
      buttons: {
        cancel: {
            text: "No, cancelar!",
            value: null,
            visible: true,
            className: "btn-warning",
            closeModal: true,
        },
        confirm: {
            text: "Sí!",
            value: true,
            visible: true,
            className: "",
            closeModal: true,
        }
      }
    }).then(isConfirm => {
      if (isConfirm) {
        var data = $('#generalData').serialize();
        $.ajax({
          type: "POST",
          url: '/generalData/'+resumenId,
          data: data,
          async: false,
        })
        .done(function (data) {
          $('#show_summary').modal('hide');
        })
        .fail(function (data) {
          console.log("Fail");
        })
      }
    });
  }

  function submitIdentification(id){
    swal({
      title: "Confirmación",
      text: "¿Confirma que desea guardar los cambios?",
      icon: "warning",
      showCancelButton: true,
      buttons: {
        cancel: {
            text: "Cancelar",
            value: null,
            visible: true,
            className: "btn-warning",
            closeModal: true,
        },
        confirm: {
            text: "Continuar",
            value: true,
            visible: true,
            className: "",
            closeModal: true,
        }
      }
    }).then(isConfirm => {
      if (isConfirm) {
        var data = $('#identification-'+id).serialize();
        $.ajax({
            type: "POST",
            url: '/identification/'+id,
            data: data,
            async: false,
        })
        .done(function (data) {
            response = data;
            summary_edited = true;
            toastr.success('Guardado exitosamente!');
            getSummaryData();
        })
        .fail(function (data) {
            console.log("Fail");
        })
      }
    });
  }

  function deleteSample(id){

      swal({
          title: "Confirmación",
          text: "Le recordamos que eliminar una muestra puede generar perdida de trabajo realizado si ya se encuentra procesada o tiene servicios asociados. ¿Confirma que desea eliminar?",
          icon: "warning",
          showCancelButton: true,
          buttons: {
          cancel: {
              text: "Cancelar",
              value: null,
              visible: true,
              className: "btn-warning",
              closeModal: true,
          },
          confirm: {
              text: "Continuar",
              value: true,
              visible: true,
              className: "",
              closeModal: true,
          }
          }
      }).then(isConfirm => {
          if (isConfirm) {
              $.ajax({
                  type: "GET",
                  url: '/delete-sample/'+id,
                  async: false,
              })
              .done(function (data) {
                  summary_edited = true;
                  toastr.success('La muestra se ha eliminado exitosamente!');
                  getSummaryData();
              })
              .fail(function (data) {
                  console.log("Fail");
              })
          }
      });
  }

  var analisis_agregados = {{analysis_selected}};
  var research_id = {{research.pk}};

  Array.prototype.insert = function ( index, item ) {
    this.splice( index, 0, item );
  };

  $(document).on('click', '.addAnalysis', function(){
    var analysis_id = $(this).data("analysis-id");
    analisis_agregados.push(analysis_id);
    var tr = $(this).parent().parent().parent();
    
    var row_data = [];
    tr.find('td').each(function() {
      var the_td = $(this).clone();

      if (the_td.find('.addAnalysis').length) {
        the_td.find('.addAnalysis').remove();
        the_td.find('.btn-group').append('<button \
          class="btn btn-danger removeAnalysis" \
          data-analysis-id="'+analysis_id+'" \
          data-toggle="tooltip" \
          data-placement="top" \
          title="Quitar del Estudio"> \
          <i class="fa fa-close fa-fx"></i> Quitar \
        </button>');
      }
      
      row_data.push(the_td.html());
    });

    if (row_data[4].trim() != "--"){
      var fm_year = row_data[4].split("/")[2];
      var fm_month = row_data[4].split("/")[1];
      row_data.insert(5, fm_year);
      row_data.insert(6, fm_month);
    } else {
      row_data.insert(5, "--");
      row_data.insert(6, "--");
    }
    
    tabla_casos.row(tr).remove().draw();
    tabla_casos2.row.add(row_data).draw();
  });

  $(document).on('click', '.removeAnalysis', function(){
    var analysis_id = $(this).data("analysis-id");
    analisis_agregados = _.without(analisis_agregados, analysis_id);
    var tr = $(this).parent().parent().parent();
    
    var row_data = [];
    tr.find('td').each(function() {
      var the_td = $(this).clone();

      if (the_td.find('.removeAnalysis').length) {
        the_td.find('.removeAnalysis').remove();
        the_td.find('.btn-group').append('<button \
          class="btn btn-success addAnalysis" \
          data-analysis-id="'+analysis_id+'" \
          data-toggle="tooltip" \
          data-placement="top" \
          title="Ingresar al Estudio"> \
          <i class="fa fa-plus fa-fx"></i> Ingresar \
        </button>');
      }
      
      row_data.push(the_td.html());
    });

    if (row_data[4].trim() != "--"){
      var fm_year = row_data[4].split("/")[2];
      var fm_month = row_data[4].split("/")[1];
      row_data.insert(5, fm_year);
      row_data.insert(6, fm_month);
    } else {
      row_data.insert(5, "--");
      row_data.insert(6, "--");
    }

    tabla_casos2.row(tr).remove().draw();
    tabla_casos.row.add(row_data).draw();
    //tabla_casos.order([-1, 'desc']).draw();
  });

  function saveResearch(choice){
    $.ajax({
      type: "POST",
      url: '/research/' + research_id,
      data: { 'analisis' : analisis_agregados },
      async: false,
    })
    .done(function (data) {
      if (data.ok){
        if (choice == 1){
          toastr.success("Análisis agregados exitosamente.", "Listo!");
          setTimeout(function() {
            window.location='/estudios'
          }, 3000);
        } else {
          toastr.success("Análisis agregados exitosamente.", "Listo!");
          setTimeout(function() {
            location.reload();
          }, 3000);
        }
      } else {
        toastr.error("No ha sido posible registrar correctamente los análisis ingresados,   intente nuevamente.", "Lo sentimos!");
        setTimeout(function() {
          location.reload();
        }, 3000);
      }
    })
    .fail(function (data) {
      toastr.error("No ha sido posible registrar correctamente los análisis ingresados,   intente nuevamente.", "Lo sentimos!");
      setTimeout(function() {
        location.reload();
      }, 3000);
    })
  }

  $(document).on('change', '.filterYear', function(e){
    tabla_casos.column(5).search(this.value ? '^'+this.value+'$' : '', true, false ).draw();
  });

  $(document).on('change', '.filter2Year', function(e){
    tabla_casos2.column(5).search(this.value ? '^'+this.value+'$' : '', true, false ).draw();
  });

  $(document).on('change', '.filterMonth', function(e){
    tabla_casos.column(6).search(this.value ? '^'+this.value+'$' : '', true, false ).draw();
  });

  $(document).on('change', '.filter2Month', function(e){
    tabla_casos2.column(6).search(this.value ? '^'+this.value+'$' : '', true, false ).draw();
  });

  $(document).ready(function () {
    tabla_casos = $('#table-casos').DataTable({
      "rowsGroup": [0,1],
      "bPaginate" : true,
      "bLengthChange": false,
      "pageLength": 5,
      "order": [[ 0, "desc" ]],
      "orderable": false,
      "targets": 'no-sort',
      "bSort": true,
      "oLanguage": {
        "sSearch": "Filtro General"
      },
      "columnDefs": [
        {
          "targets": [0, 1, 2, 3, 4, 5 ,6, 7, 8],
          "orderable": false,
          "className": "dt-body-center",
        },
        {
          "targets": [ 0],
          "className": "dt-wd-1",
        },
        {
          "targets": [ 5,6],
          "visible": false,
        },
      ],
      initComplete: function () {
        lockScreen(0);
        this.api().columns().every( function () {
          if(this[0][0] == 5){
            var column = this;
            var select = $('<select style="width:100% !important;" class="filterYear form-control "><option value="">Todos</option></select>')
              .appendTo( $('#filter1-year'));
            select.before('<label><b>Filtro por Año Muestreo</b></label><br> ');
            column.data().unique().sort().each( function ( d, j ) {
              if (select.find('option[value="'+d+'"]').length==0)
              {
                  select.append( '<option value="'+d+'">'+d+'</option>' )
              }
            } )
            select.select2();
          }
          if(this[0][0] == 6){
            var column = this;
            var select = $('<select style="width:100% !important;" class="filterMonth form-control "><option value="">Todos</option></select>')
              .appendTo( $('#filter1-month'));
            select.before('<label><b>Filtro por Mes Muestreo</b></label><br> ');
            column.data().unique().sort().each( function ( d, j ) {
              if (select.find('option[value="'+d+'"]').length==0)
              {
                  select.append( '<option value="'+d+'">'+d+'</option>' )
              }
            } )
            select.select2();
          }
        })
      }
    });

    tabla_casos2 = $('#table-casos2').DataTable({
      "rowsGroup": [0,1],
      "bPaginate" : true,
      "bLengthChange": false,
      "pageLength": 5,
      "order": [[ 0, "desc" ]],
      "orderable": false,
      "targets": 'no-sort',
      "bSort": true,
      "oLanguage": {
        "sSearch": "Filtro General"
      },
      "columnDefs": [
        {
          "targets": [0, 1, 2, 3, 4, 5 ,6, 7, 8],
          "orderable": false,
          "className": "dt-body-center",
        },
        {
          "targets": [ 0],
          "className": "dt-wd-1",
        },
        {
          "targets": [ 5,6],
          "visible": false,
        },
      ],
      initComplete: function () {
        lockScreen(0);
        this.api().columns().every( function () {
          if(this[0][0] == 5){
            var column = this;
            var select = $('<select style="width:100% !important;" class="filter2Year form-control "><option value="">Todos</option></select>')
              .appendTo( $('#filter2-year'));
            select.before('<label><b>Filtro por Año Muestreo</b></label><br> ');
            column.data().unique().sort().each( function ( d, j ) {
              if (select.find('option[value="'+d+'"]').length==0)
              {
                  select.append( '<option value="'+d+'">'+d+'</option>' )
              }
            } )
            select.select2();
          }
          if(this[0][0] == 6){
            var column = this;
            var select = $('<select style="width:100% !important;" class="filter2Month form-control "><option value="">Todos</option></select>')
              .appendTo( $('#filter2-month'));
            select.before('<label><b>Filtro por Mes Muestreo</b></label><br> ');
            column.data().unique().sort().each( function ( d, j ) {
              if (select.find('option[value="'+d+'"]').length==0)
              {
                  select.append( '<option value="'+d+'">'+d+'</option>' )
              }
            } )
            select.select2();
          }
        })
      }
    });

    
    $('.date').datetimepicker({
      locale: 'es',
      keepOpen: false,
      format:'DD/MM/YYYY HH:mm',
      defaultDate: moment()
    });    
  });
  
</script> {% endblock scripts %}
