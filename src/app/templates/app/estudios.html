{% extends 'layout.html' %}
{% load static %}
{% block stylesheets %}
{% endblock stylesheets %}
{% block content_header %}
<div class="content-header row">
  <div class="content-header-left col-md-6 col-12 mb-2">
    <h3 class="content-header-title mb-0">Estudios</h3>
    <div class="row breadcrumbs-top">
      <div class="breadcrumb-wrapper col-12">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/">Home</a>
          </li>
          <li class="breadcrumb-item">
            <a href="#">Estudios</a>
          </li>
        </ol>
      </div>
    </div>
  </div>
  <div class="content-header-right col-md-6 col-12">
    <div class="float-md-right">
      {% if can_edit %}
      <button class="btn btn-success btn-lg round" id="add_new_research">
        <i class="fa fa-plus"></i>
        Nuevo Estudio
      </button>
      {% endif %}
    </div>
  </div>
</div>
{% endblock content_header %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">Listado de Estudios</h4>
      </div>
      <div class="card-content">
        <div class="card-body card-dashboard">
          <table class="table table-striped table-bordered research-table">
            <thead>
              <tr>
                <!-- <th>Id</th> -->
                <th>Código</th>
                <th>Clientes</th>
                <th>Nombre Estudio</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Fecha Apertura</th>
                <th>Responsable <br>Interno</th>
                <th>Responsable <br>Externo</th>
                <th>Opciones</th>
              </tr>
            </thead>
            <tbody>
              {% for research in research_list %}
                  <tr id="research-{{ research.id }}">
                    <!-- <td>{{ research.id }}</td> -->
                    <td>
                      <strong>{{ research.code }}</strong>
                    </td>
                    <td>
                      {{ research.clients.all|join:", " }}
                    </td>
                    <td>
                      {{ research.name|default:"" }}
                    </td>
                    <td>
                      {{ research.get_type_display|default:"" }}
                    </td>
                    <td>
                      {% if research.status %} 
                        <label class='text-success'>Habilitado</label>
                      {% else %}
                        <label class='text-danger'>Deshabilitado</label>
                      {% endif %}
                    </td>
                    <td>
                      {{ research.init_date|date:'d/m/Y H:i'}}
                    </td>
                    <td>
                      {{ research.internal_responsible.get_full_name}}
                    </td>
                    <td>
                      {{ research.external_responsible|default:""}}
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        <button 
                          class="btn btn-primary editResearch" 
                          data-id="{{ research.id }}" 
                          data-toggle="tooltip" 
                          data-placement="top" 
                          title="Editar Estudio">
                          <i class="fa fa-edit fa-fx"></i>
                        </button>
                        {% if research.status %}
                        <a href="/research/{{research.id}}"
                          class="btn btn-warning"
                          data-toggle="tooltip" 
                          data-placement="top" 
                          title="Ingresar al Estudio">
                          <i class="fa fa-sign-in fa-fx"></i>
                        </a>
                        {% endif %}

                      </div>
                    </td>
                  </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade text-left" id="new_research_modal" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog" role="document" style="min-width: 50% !important;" >
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="title"></h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="font-size:14px !important; max-height: calc(100vh - 150px); overflow-y:scroll;">
        <form method="POST" action="/research/new" id="create_research_form" class="form">
          
          <div class="row">
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="input-name">Nombre de Estudio</label>
                <input required type="text" class="form-control" name="name" id="input-name" />
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label for="select-clients">Clientes</label>
                <select required class="select2 form-control select-clients" id="select-clients" name="clients" multiple>
                  {% for client in clients_available %}
                    <option value="{{client.id}}">{{client.name}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="input-init-date">Fecha Apertura</label>
                <input required type="text" class="form-control date" name="init_date" id="input-init-date" />
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label for="input-type">Tipo de Estudio</label>
                <select required class="form-control" name="type" id="select-type">
                  <option value="1">Estudio Vehice</option>
                  <option value="2">Seguimiento de rutina</option>
                </select>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="input-name">Responsable Externo</label>
                <input required class="form-control responsible_place" name="external_responsible" id="input-external-responsible" onclick="responsibleModal()" value=""/>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label for="input-name">Responsable Interno</label>
                <select required class="select2 form-control select-users" name="internal_responsible" id="select-internal-responsible">
                  {% for usr in users_available %}
                    <option value="{{usr.id}}">{{usr.get_full_name}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <div class="col-md-8">
              <div class="form-group">
                <label for="input-type">Descripción</label>
                <textarea required row="3" class="form-control" name="description" id="input-description"></textarea>
              </div>
            </div>

            <div class="col-md-4">
              <div class="form-group">
                <label for="select-status">Estado</label>
                <select required class="form-control" name="status" id="select-status">
                  <option selected value="1">HABILITADO</option>
                  <option value="0">DESHABILITADO</option>
                </select>
              </div>
            </div>

          </div>
          
          <input id="input-id" name="id" type="hidden" value="" />

          <div class="modal-footer">
            <button type="submit" class="btn btn-lg btn-primary" id="submit-research">
              <i class="fa fa-sign-in"></i> <span id="modal_research_button"></span>
            </button>
          </div>

        </form>   
      </div>
    </div>
  </div>
</div>

<div class="modal fade text-left" id="responsible_modal" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog" role="" style="min-width:80% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="title"> Lista de Responsables <span></span></h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="font-size:12px !important;">
        <div style="padding: 10px;background-color: #f2efed;">
          <form action="#" id="responsible_form" onsubmit="saveResponsible(); return false;">
            <h6 class="form-section mt-2">Responsable</h6>
            <div class="row generalInfo">
              <div class="col-sm-3 form-group">
                <input class="form-control" name="id" hidden />
                <input class="form-control" name="name" placeholder="Nombre*" required/>
              </div>
              <div class="col-sm-3 form-group">
                <input class="form-control" name="email" placeholder="Correos Electrónicos*" required/>
                <p>* Puede ingresar multiples direcciones separadas por punto y coma (;)</p>
              </div>
              <div class="col-sm-2 form-group">
                <input class="form-control" name="phone" placeholder="Teléfono" />
              </div>
              <div class="col-sm-3 form-group">
                <input class="form-control" name="job" placeholder="Cargo*" required/>
              </div>
              <div class="col-sm-1 form-group">
                <button type="submit" class="btn btn-primary">
                  <i class="fa fa-save"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
        <hr>
        <div class="col-md-12" id="responsible_table_div">
          
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock content %} {% block scripts %}

<script id="responsible_table_template" type="text/x-lodash-template">
  <table class="table table-bordered table-condensed" id="responsible_table" style="font-size:13px;">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Teléfono</th>
        <th>Cargo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <% _.each(responsibles, function (responsible) { %>
        <tr id="responsible-<%= responsible.id %>">
        <td><%= responsible.name %></td>
        <td><%= _.replace(responsible.email, /;/g, '</br>') %></td>
        <td><%= responsible.phone %></td>
        <td><%= responsible.job %></td>
        <td>
          <button class="btn btn-success" data-dismiss="modal" onclick="selectResponsible('<%= responsible.id %>','<%= responsible.name %>')"><i class="fa fa-check"></i></button>
          <button class="btn btn-info" onclick="editResponsible('<%= responsible.id %>','<%= responsible.name %>','<%= responsible.email %>','<%= responsible.phone %>','<%= responsible.job %>')"><i class="fa fa-edit"></i></button>
          <button class="btn btn-danger" onclick="disabledResponsible('<%= responsible.id %>')"><i class="fa fa-times"></i></button>
        </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</script>

<script type="text/javascript">



  $(document).ready(function () {
    var tableChildRows = $('.research-table').DataTable({
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.10.16/i18n/Spanish.json"
      },
      ordering: false,
    });

    $('.select-clients').select2({'width':'100%'});
    $('.select-users').select2({'width':'100%'});
    
    $('.date').datetimepicker({
      locale: 'es',
      keepOpen: false,
      format:'DD/MM/YYYY HH:mm',
      defaultDate: moment()
    });    
  });

  $(document).on('click', '#add_new_research', function(e){
    $('#title').html("Formulario de Ingreso de Estudio");
    $('#modal_research_button').html("Abrir");
    $('#submit-research').removeClass("saveEditResearch");

    // reset form
    $('#input-name').val('');
    $('#select-clients').val('').trigger('change');
    $('#input-init-date').val('');
    $('#input-external-responsible').val('');
    $('#input-description').val('');
    $('#new_research_modal').modal('show');
  });

  $(document).on('click', '.editResearch', function(e){
    var research_id = $(this).data('id');
    $('#title').html("Editar Estudio");
    $('#modal_research_button').html("Guardar");
    $('#submit-research').addClass("saveEditResearch");

    var url = Urls.get_research(research_id);

    $.ajax({
      type: "GET",
      url: url,
    })
    .done(function (data) {
      if (data.ok){
        r = data.research;
        $('#input-id').val(r.id);
        $('#input-name').val(r.name);
        $('#select-clients').val('').trigger('change');
        $('#select-clients').val(r.clients).trigger('change');
        $('#input-init-date').val(r.init_date);
        $('#select-type').val(r.type);
        $('#input-external-responsible').val(r.external_responsible);
        $('#select-internal-responsible').val(r.internal_responsible).trigger('change');
        $('#input-description').val(r.description);
        console.log(r.status)
        $('#select-status').val(r.status);
        
        $('#new_research_modal').modal('show');
      }
    })
    .fail(function () {
      console.log("Fail")
    });

  });

  $(document).on('click', '.saveEditResearch', function(e){
    e.preventDefault();
    var research_id = $('#input-id').val();
    var url = Urls.get_research(research_id);
    $.ajax({
      type: "GET",
      url: url,
      async: false
    })
    .done(function (data) {
      if (data.ok){
        r = data.research;
        var selected_clients = $('#select-clients').val();
        
        var removing_services = false;
        $.each(r.client_services, function(key, value){
          if (!selected_clients.includes(key)){
            if (!removing_services){
              removing_services = true;
            }
          }
        });

        if (removing_services){
          swal({
            title: "Confirmación",
            text: "Estás eliminando un cliente que tiene servicios asociados al presente estudio, ¿deseas continuar?",
            icon: "warning",
            showCancelButton: true,
            buttons: {
              cancel: {
                  text: "Cancelar!",
                  value: null,
                  visible: true,
                  className: "btn-warning",
                  closeModal: true,
              },
              confirm: {
                  text: "Continuar",
                  value: true,
                  visible: true,
                  className: "",
                  closeModal: true,
              }
            }
          }).then(isConfirm => {
            if (isConfirm) {
              $('#create_research_form').submit();
            }
          });
        
        } else {
          $('#create_research_form').submit();
        }
      }
    })
    .fail(function () {
      console.log("Fail")
    });
    
  });


  function getSummaryData(){
    var entryform_id = resumenId;
    var clsd = is_closed;
    var url = Urls.entryform_id(entryform_id);
    $.ajax({
      type: "GET",
      url: url,
    })
    .done(function (data) {
      fillSummary(data);
      if(clsd){
        $('#btn_save').hide();
        $('.btn-save-identification').hide();
      }
      else{
        $('#btn_save').show();
        $('.btn-save-identification').show();
      }
      $("#show_summary").modal("show");
    })
    .fail(function () {
      console.log("Fail")
    });
  }

  function fillSummary(data){
    var edit = false;
    if ( "{{edit}}" == "True"){
      edit = true;
    } else {
      edit = false;
    }
    var selectClient = '<select class="select2 form-control selectOpt" id="client" name="client">';
    $.each(data.customers_list, function(j, o){
        selectClient += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectClient +='</select>';

    var selectFix = '<select class="select2 form-control selectOpt" id="fixative" name="fixative">';
    $.each(data.fixtatives_list, function(j, o){
        selectFix += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectFix +='</select>';

    var selectEntryformType = '<select class="select2 form-control selectOpt" id="entryform_type" name="entryform_type">';
    $.each(data.entryform_types_list, function(j, o){
        selectEntryformType += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectEntryformType +='</select>';

    var selectSpecie = '<select class="select2 form-control selectOpt" id="specie" name="specie">';
    $.each(data.species_list, function(j, o){
        selectSpecie += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectSpecie +='</select>';

    var selectlarvalstage = '<select class="select2 form-control selectOpt" id="larvalstage" name="larvalstage">';
    $.each(data.larvalStages_list, function(j, o){
        selectlarvalstage += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectlarvalstage +='</select>';

    var selectwatersource = '<select class="select2 form-control selectOpt" id="watersource" name="watersource">';
    $.each(data.waterSources_list, function(j, o){
        selectwatersource += '<option value="'+o.id+'">'+o.name+'</option>';
    });
    selectwatersource +='</select>';

    $('.NoCasoSummary').html(data.entryform.no_caso);
    $('.summaryClient').html('<label>Cliente:</label>' + selectClient);
    $('.summaryCompany').html('<label>Empresa:</label> <input class="form-control" value="'+ data.entryform.company+'" name="company"/>');
    $('.summaryCenter').html('<label>Centro:</label> <input class="form-control" value="'+ data.entryform.center+'" name="center"/>');
    $('.summaryResponsible').html('<label>Responsable:</label> <input class="form-control responsible_place" readonly value="'+ data.entryform.responsible+'" name="responsable" onclick="responsibleModal()"/>');
    $('.summaryReception').html('<label>Fecha recepción:</label> <div class="input-group date" id=""><input type="text" class="form-control" name="recive" value="'+ moment(data.entryform.created_at).format("DD/MM/YYYY HH:mm")+'"/><div class="input-group-append"><span class="input-group-text"><span class="fa fa-calendar"></span></span></div></div> ' );
    $('.sumarrySampling').html('<label>Fecha muestreo:</label> <div class="input-group date" id=""><input type="text" class="form-control" name="muestreo" value="'+ moment(data.entryform.sampled_at).format("DD/MM/YYYY HH:mm")+'"/><div class="input-group-append"><span class="input-group-text"><span class="fa fa-calendar"></span></span></div></div> ' );
    $('.summaryNoOrder').html('<label>Nro Orden de Trabajo:</label> <input class="form-control" value="'+ data.entryform.no_order+'" name="no_order"/>');
    $('.summaryNoRequest').html('<label>Nro Solicitud Interlaboratorio:</label> <input class="form-control" value="'+ data.entryform.no_request+'" name="no_solic"/>');
    $('.summaryAnamnesis').html('<label>Anamnesis:</label> <textarea class="form-control" row="2" name="anamnesis" {% if not edit %}disabled{% endif %} >'+ data.entryform.anamnesis+'</textarea>');
    $('.summaryFixative').html('<label>Fijador:</label>'+ selectFix);
    $('.summaryEntryformType').html('<label>Tipo de Ingreso:</label>'+ selectEntryformType);
    
    $('.summarySpecie').html('<label>Especie:</label>'+selectSpecie  );
    $('.summaryDevStatus').html('<label>Estadío Desarrollo:</label>'+selectlarvalstage ); 
    $('.summaryWaterSource').html('<label>Fuente de agua:</label>'+selectwatersource);

    // var tpl_identification = '';
    var tpl_identification = '<div class="col-sm-12"> <hr><h6 class="form-section mt-2"> <b>Identificación</b>&nbsp;&nbsp;&nbsp;';
    if (edit && !is_closed){
      tpl_identification += '<a href="javascript:void(0);" onclick="newIdentification('+data.entryform.id+')" class="btn btn-secondary btn-sm"> <i class="fa fa-plus"></i> Agregar Identificación</a>'
    }
    tpl_identification += '</h6></div>';

    $.each(data.entryform.identifications, function(i, item){
      var optimum = ""
      if (!item.is_optimum){
        optimum = "selected"
      }
      var selectOptimum = '<select class="select2 form-control selectOpt" name="optimo"><option value="1">Si</option><option value="0" '+optimum+'>No</option></select>'
      
      var selectOrgans = '<select class="select2 form-control selectOrgs" name="organs" multiple>';

      $.each(data.organs, function(j, o){
        if(item.organs_bv_set.findIndex(x => x.id === o.id) != -1){
          selectOrgans += '<option value="'+o.id+'" selected>'+o.name+'</option>';
        }
        else
          selectOrgans += '<option value="'+o.id+'">'+o.name+'</option>';
      });
      selectOrgans +='</select>';
      
      tpl_identification += '<div class="col-md-4"><form id="identification-'+item.id+'" action="#" method="POST">';
      tpl_identification += '<div class="alert alert-light"><div class="row">';
      tpl_identification += '<div class="form-group col-md-6"><label>Estanque/Jaula:</label> <input class="form-control" value="'+ item.cage+'"  name="jaula"/></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Grupo/Nro Caso Cliente:</label> <input class="form-control" value="'+ item.group+'"  name="grupo" /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Peces:</label> <input class="form-control just_increasing" name="no_fish" data-val="'+ item.no_fish+'" value="'+ item.no_fish+'" /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Contenedores:</label> <input class="form-control" type="number" value="'+ item.no_container+'"  name="contenedores" /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Peso (gramos):</label> <input class="form-control" type="number" value="'+ item.weight+'"  name="peso" /></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Óptimo?:</label>'+ selectOptimum+'</div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Características Extras:</label> <textarea class="form-control" rows="2" name="extras">'+ item.extra_features_detail+' </textarea></div>';
      tpl_identification += '<div class="form-group col-md-6"><label>Observaciones:</label> <textarea class="form-control" rows="2" name="observation">'+ item.observation+' </textarea></div>';
      tpl_identification += '<div class="form-group col-md-9"><label>Órganos:</label>'+selectOrgans+'</div>';

      if (edit && !is_closed) {
        tpl_identification += '<div style="padding-top:25px;"><a href="javascript:void(0);" onclick="submitIdentification('+item.id+')" class="btn btn-primary"> <i class="fa fa-save"></i></a>';
        if (item.removable){
          tpl_identification += '<a href="javascript:void(0);" onclick="removeIdentification('+item.id+')" class="btn btn-danger"> <i class="fa fa-trash"></i></a>';
        }
        tpl_identification += '</div>';
      }
      tpl_identification += '</div></div>';
      tpl_identification += '</form></div>';
    });

    // tpl_identification += '</div>';
    $('.summaryIdentification').html(tpl_identification);

    var tpl_exams = '<div class="col-sm-12"><h6 class="form-section mt-2"> <b>Servicios</b></h6></br>';
    $.each(data.entryform.analyses, function(i, item){
      tpl_exams += '<div class="alert alert-light"><b>'+ item.exam__name +' (Tinción: '+item.stain+')</b> <span class="pull-right">'
      if(item.patologo__first_name != null)
        tpl_exams += '<b>Patólogo:</b> '+item.patologo__first_name+' ';
      if(item.patologo__last_name != null)
        tpl_exams += item.patologo__last_name;
      tpl_exams += '</span> <br> <b>Fecha: </b>'+ moment(item.created_at).format("DD/MM/YYYY HH:mm");
      tpl_exams += '</span> <br> <b>Estado: </b>'+ item.status;
      tpl_exams += '</span> <br> <b>Muestras a cobrar: </b>'+ item.samples_count;
      tpl_exams += '</span> <br> <b>Total órganos: </b>'+ item.organs_count;

      
      if (item.service_comments.length > 0) {
        tpl_exams += '<br> <b>Comentarios:</b><br><br>';
        $.each(item.service_comments, function(j, item2){
          tpl_exams += '<p style="margin-left: 5%;"><b>'+item2.done_by+' ('+item2.created_at+'):</b> <br> '+item2.text+'</p>'
        });
      }
      

      tpl_exams += '</div>';
    });

    tpl_exams += '</div>';
    $('.summaryExams').html(tpl_exams);

    var tpl_samples = '<div class="col-sm-12"><h6 class="form-section mt-2"> <b>Muestras</b></h6></br><table class="table table-bordered table-xs">';
    tpl_samples += '<thead><tr><th>Pez</th><th>Identificación</th><th>Análisis</th><th>Tinción</th><th>Órganos</th></tr></thead><tbody>';
    var patologos = {};
    $.each(data.patologos, function(i, v){
      patologos[v.id]=v.first_name+' '+v.last_name;
    })
    
    $.each(data.samples, function(i, item){
      var len = 1;
      var tpl_exams = ""
      $.each(item.sample_exams_set, function(j, v){
        len+=1;
        tpl_exams += '<tr><td>'+v.exam_name+'</td>';
        tpl_exams += '<td>'+v.sample_stain_abbr+'</td>';
        tpl_exams += '<td>'+ Object.keys(v.organ_id).map(function(k){return v.organ_id[k].name}).join(", ") +'</td></tr>';
      });
      tpl_samples += '<tr id="sample-id-'+item.id+'">';
      if (edit && !is_closed ){
        tpl_samples += '<td rowspan="'+len+'"><button type="button" class="btn btn-sm btn-danger round" onclick="deleteSample('+item.id+');">X</button> '+ item.index +'</td>';
      } else {
        tpl_samples += '<td rowspan="'+len+'">'+ item.index +'</td>';
      }
      tpl_samples += '<td rowspan="'+len+'">'+ item.identification.cage +'-'+item.identification.group+'</td>';
      tpl_samples += '</tr>';
      tpl_samples += tpl_exams;
      
    });

    tpl_samples += '</tbody></table></div>';
    $('.summarySamples').html(tpl_samples);

    if (data.entryform.customer != null) {
      $('#client').val(data.entryform.customer.id);
    }
    if (data.entryform.entryform_type != null) {
      $('#entryform_type').val(data.entryform.entryform_type.id);
    }
    if (data.entryform.fixative != null) {
      $('#fixative').val(data.entryform.fixative.id);
    }
    if (data.entryform.specie != null) {
      $('#specie').val(data.entryform.specie.id);
    }
    if (data.entryform.watersource != null) {
      $('#watersource').val(data.entryform.watersource.id);
    }
    if (data.entryform.larvalstage != null) {
      $('#larvalstage').val(data.entryform.larvalstage.id);
    }

    $('.selectOpt').select2({'width':'100%'});
    $('.selectOrgs').select2({'width':'100%'});
    
    $('.date').datetimepicker({
      locale: 'es',
      keepOpen: false,
      format:'DD/MM/YYYY HH:mm'
    });
    
    if (!edit || is_closed) {
      $('#generalData :input, select').prop('disabled', true);
      $('.summaryIdentification :input, select').prop('disabled', true);
    }

    // $('#datetime_sampled_at').datetimepicker({
    //     locale: 'es',
    //     keepOpen: false,
    //     format:'DD/MM/YYYY HH:mm'
    //   });
  }
  
  function submitGeneralData(){
    swal({
      title: "Confirmación",
      text: "¿Está seguro que desea guardar los cambios?",
      icon: "warning",
      showCancelButton: true,
      buttons: {
        cancel: {
            text: "No, cancelar!",
            value: null,
            visible: true,
            className: "btn-warning",
            closeModal: true,
        },
        confirm: {
            text: "Sí!",
            value: true,
            visible: true,
            className: "",
            closeModal: true,
        }
      }
    }).then(isConfirm => {
      if (isConfirm) {
        var data = $('#generalData').serialize();
        $.ajax({
          type: "POST",
          url: '/generalData/'+resumenId,
          data: data,
          async: false,
        })
        .done(function (data) {
          $('#show_summary').modal('hide');
        })
        .fail(function (data) {
          console.log("Fail");
        })
      }
    });
  }

  function responsibleModal() {
    $('#responsible_modal').modal('show');
    reloadResponsibleTable();
  }

  function reloadResponsibleTable() {
    $.ajax({
      type: "GET",
      url: '/responsible',
    })
    .done(function (data) {
      if (data.ok)
      {
        var groupTemplate = document.getElementById("responsible_table_template").innerHTML;
        var templateFn = _.template(groupTemplate);
        var templateHTML = templateFn(data);

        $("#responsible_table_div").html(templateHTML);

        $('#responsible_table').DataTable({
          "destroy": true,
          "oLanguage": {
            "sUrl": "https://cdn.datatables.net/plug-ins/1.10.16/i18n/Spanish.json"
          },
          initComplete: function () {
            setTimeout(function(){ $('#responsible_table_filter input[type=search]').focus(); }, 500);
          },
        });
      }
    });
  }

  function saveResponsible(e) {
    let form_data = $("#responsible_form").serialize();
    $.ajax({
      type: "POST",
      url: '/responsible',
      data: form_data,
    })
      .done(function (data) {
        if (data.ok)
        {
          reloadResponsibleTable()
          $("#responsible_form")[0].reset();
          toastr.success('Se guardó satisfactoriamente', '');
        }
        else
        {
          toastr.error('No se pudo guardar satisfactoriamente', 'Aviso');
        }
      })
      .fail(function (data) {
        console.log("Fail");
      })
  }

  function editResponsible(id, name, email, phone, job) {
    $('#responsible_form input[name=id]').val(id);
    $('#responsible_form input[name=name]').val(name);
    $('#responsible_form input[name=email]').val(email);
    $('#responsible_form input[name=phone]').val(phone);
    $('#responsible_form input[name=job]').val(job);
  }

  function disabledResponsible(id) {
    $.ajax({
      type: "DELETE",
      url: '/responsible/' + id,
    })
      .done(function (data) {
        if (data.ok)
        {
          reloadResponsibleTable()
          toastr.success('Se eliminó satisfactoriamente', '');
        }
        else
        {
          toastr.error('No se pudo eliminar satisfactoriamente', 'Aviso');
        }
      })
      .fail(function (data) {
        console.log("Fail");
      })
  }

  function selectResponsible(id, name) {
    $.each($('.responsible_place'), function(i, v){
      $(v).val(name);
    })
    $.each($('#responsible_input'), function(i, v){
      $(v).val(name);
    })
  }

  function deleteSample(id){

      swal({
          title: "Confirmación",
          text: "Le recordamos que eliminar una muestra puede generar perdida de trabajo realizado si ya se encuentra procesada o tiene servicios asociados. ¿Confirma que desea eliminar?",
          icon: "warning",
          showCancelButton: true,
          buttons: {
          cancel: {
              text: "Cancelar",
              value: null,
              visible: true,
              className: "btn-warning",
              closeModal: true,
          },
          confirm: {
              text: "Continuar",
              value: true,
              visible: true,
              className: "",
              closeModal: true,
          }
          }
      }).then(isConfirm => {
          if (isConfirm) {
              $.ajax({
                  type: "GET",
                  url: '/delete-sample/'+id,
                  async: false,
              })
              .done(function (data) {
                  summary_edited = true;
                  toastr.success('La muestra se ha eliminado exitosamente!');
                  getSummaryData();
              })
              .fail(function (data) {
                  console.log("Fail");
              })
          }
      });
  }

</script> {% endblock scripts %}
